{% extends "base.html" %}

{% block title %}Analysis Report - AI Code Reviewer{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col">
            <h2>Code Analysis Report</h2>
            <p class="text-muted">File: {{ scan.filename }}</p>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col">
            <ul class="nav nav-tabs" id="issueTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="all-tab" data-bs-toggle="tab" href="#all" role="tab">
                        All Issues <span class="badge bg-secondary">{{ scan.total_issues }}</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="bugs-tab" data-bs-toggle="tab" href="#bugs" role="tab">
                        Bugs <span class="badge bg-danger">{{ scan.bugs|length }}</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="security-tab" data-bs-toggle="tab" href="#security" role="tab">
                        Security <span class="badge bg-warning">{{ scan.security_issues|length }}</span>
                    </a>
                </li>
            </ul>

            <div class="tab-content mt-3" id="issueTabsContent">
                <!-- All Issues Tab -->
                <div class="tab-pane fade show active" id="all" role="tabpanel">
                    {% for issue in scan.all_issues %}
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <span class="badge {% if issue.type == 'bug' %}bg-danger{% else %}bg-warning{% endif %} me-2">
                                            {{ issue.type|title }}
                                        </span>
                                        <span class="badge bg-{{ issue.severity }}">{{ issue.severity|title }}</span>
                                    </div>
                                    <small class="text-muted">Line {{ issue.line }}</small>
                                </div>

                                <h5 class="card-title">{{ issue.message }}</h5>

                                <!-- Code Snippet -->
                                <div class="bg-light p-3 rounded mb-3">
                                    <code>{{ issue.code_snippet }}</code>
                                </div>

                                <!-- Suggestion -->
                                <div class="mb-3">
                                    <i class="fas fa-lightbulb text-warning"></i>
                                    <strong>Suggestion:</strong>
                                    <p class="mb-0">{{ issue.suggestion }}</p>
                                </div>

                                <!-- Fix -->
                                {% if issue.fix %}
                                <div class="mb-3">
                                    <strong>Suggested Fix:</strong>
                                    <pre class="bg-light p-2 rounded mt-2"><code>{{ issue.fix.after }}</code></pre>
                                    <p class="text-muted small">{{ issue.fix.explanation }}</p>
                                    
                                    <button class="btn btn-sm btn-primary apply-fix"
                                            data-line="{{ issue.line }}"
                                            data-before="{{ issue.code_snippet }}"
                                            data-after="{{ issue.fix.after }}">
                                        Apply Fix
                                    </button>
                                    <button class="btn btn-sm btn-secondary ignore-issue ms-2">
                                        Ignore
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <!-- Bugs Tab -->
                <div class="tab-pane fade" id="bugs" role="tabpanel">
                    {% for bug in scan.bugs %}
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="badge bg-danger">{{ bug.severity|title }}</span>
                                    <small class="text-muted">Line {{ bug.line }}</small>
                                </div>

                                <h5 class="card-title">{{ bug.message }}</h5>

                                <!-- Code Snippet -->
                                <div class="bg-light p-3 rounded mb-3">
                                    <code>{{ bug.code_snippet }}</code>
                                </div>

                                <!-- Suggestion -->
                                <div class="mb-3">
                                    <i class="fas fa-lightbulb text-warning"></i>
                                    <strong>Suggestion:</strong>
                                    <p class="mb-0">{{ bug.suggestion }}</p>
                                </div>

                                <!-- Fix -->
                                {% if bug.fix %}
                                <div class="mb-3">
                                    <strong>Suggested Fix:</strong>
                                    <pre class="bg-light p-2 rounded mt-2"><code>{{ bug.fix.after }}</code></pre>
                                    <p class="text-muted small">{{ bug.fix.explanation }}</p>
                                    
                                    <button class="btn btn-sm btn-primary apply-fix"
                                            data-line="{{ bug.line }}"
                                            data-before="{{ bug.code_snippet }}"
                                            data-after="{{ bug.fix.after }}">
                                        Apply Fix
                                    </button>
                                    <button class="btn btn-sm btn-secondary ignore-issue ms-2">
                                        Ignore
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <!-- Security Tab -->
                <div class="tab-pane fade" id="security" role="tabpanel">
                    {% for issue in scan.security_issues %}
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="badge bg-warning">{{ issue.severity|title }}</span>
                                    <small class="text-muted">Line {{ issue.line }}</small>
                                </div>

                                <h5 class="card-title">{{ issue.message }}</h5>

                                <!-- Code Snippet -->
                                <div class="bg-light p-3 rounded mb-3">
                                    <code>{{ issue.code_snippet }}</code>
                                </div>

                                <!-- Suggestion -->
                                <div class="mb-3">
                                    <i class="fas fa-lightbulb text-warning"></i>
                                    <strong>Suggestion:</strong>
                                    <p class="mb-0">{{ issue.suggestion }}</p>
                                </div>

                                <!-- Fix -->
                                {% if issue.fix %}
                                <div class="mb-3">
                                    <strong>Suggested Fix:</strong>
                                    <pre class="bg-light p-2 rounded mt-2"><code>{{ issue.fix.after }}</code></pre>
                                    <p class="text-muted small">{{ issue.fix.explanation }}</p>
                                    
                                    <button class="btn btn-sm btn-primary apply-fix"
                                            data-line="{{ issue.line }}"
                                            data-before="{{ issue.code_snippet }}"
                                            data-after="{{ issue.fix.after }}">
                                        Apply Fix
                                    </button>
                                    <button class="btn btn-sm btn-secondary ignore-issue ms-2">
                                        Ignore
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle Apply Fix buttons
    document.querySelectorAll('.apply-fix').forEach(button => {
        button.addEventListener('click', function() {
            const line = this.dataset.line;
            const before = this.dataset.before;
            const after = this.dataset.after;
            
            // Update the code display
            const codeElement = this.closest('.card').querySelector('code');
            if (codeElement) {
                codeElement.textContent = after;
            }
            
            // Update button state
            this.textContent = 'Fix Applied';
            this.disabled = true;
            this.classList.remove('btn-primary');
            this.classList.add('btn-success');
        });
    });

    // Handle Ignore buttons
    document.querySelectorAll('.ignore-issue').forEach(button => {
        button.addEventListener('click', function() {
            const card = this.closest('.card');
            if (card) {
                card.style.opacity = '0.5';
                this.textContent = 'Ignored';
                this.disabled = true;
                
                // Disable the apply fix button
                const applyButton = card.querySelector('.apply-fix');
                if (applyButton) {
                    applyButton.disabled = true;
                }
            }
        });
    });
});
</script>
{% endblock %} 